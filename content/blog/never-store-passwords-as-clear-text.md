---
title: "Never store passwords as clear text"
date: "2007-12-13"
tags: ["python"]
slug: "never-store-passwords-as-clear-text"


---

<i>Never store passwords as clear text</i>, that is the general rule with any application that has a database backend that is used for authentication into the system. Why? <br /><br />Basic authentication with a database usually works by comparing username and password combination  that the user entered to values in the database table containing user details such as login name, password etc...It might be possible for a user with correct credentials to be able to inject SQL queries to the application, something like;<br /><br /><b>SELECT * FROM USERS;</b> <br /><br /><font size='1'><i>assuming the user can guess or knows the table containing user data.</i></font> <br /><br />If passwords are in clear text then lo and behold the users now has access to all other users login name and passwords. Anyway this post is not about security of database backed applications but a post about how i overcame different versions of Python and py-bcrypt's support.<br /><br />As i've posted before i've
been working at a web development company as a Python programmer. It's a Zope 'shop' in the sense that there main application, developed in house a shopping cart system is developed using Zope. Anyway i just developed 'External Scripts' to do specialized stuff for customers. But recently i've been working on a 'time/job tracking' web application using web.py. I've mentioned this in a previous post. So here is the versions of Python,web.py and py-bcrypt that i used to develop the tracker;<br /><br /><ul><br />    <li> Python 2.5.1 </li><br />    <li> py-bcrypt-0.1 (Python 2.4 or higher) </li><br />    <li> MySQL-5 </li><br /></ul><br /><br />Anyway, this past week the application was put on a live <b>production server</b>. That has;<br /><br /><ul><br />    <li> Python2.3 </li><br />    <li> Postgres </li><br /></ul><br /><br />I've also used decorators to 'decorate' functions to restrict access to certain URL paths. Take a guess in which version decorators was introduced into Python?
You guessed right Python 2.4 got blessed with decorators. Guess what the lead/senior developer did ? He re-wrote most of the code to just use plain function calls instead of decorators...he re-wrote...instead of the simpler solution of installing Python >=2.4. (Converted the decorator to a plain function which is called in all other functions that was decorated with it). <br /><br />I mentioned above that py-bcrypt requires Python >= 2.4 because it needs the function os.urandom which was introduced into Python 2.4. Oh slap! i've got Python 2.3 so we can't generate hashes...the solution that was suggested to me was...."write/copy urandom" i think that was one of the moments in my not so long professional career that i thought that someone more senior and with more was wrong. I would have instead installed Python 2.5 on the server, which seemed to be the 'path of least resistance'.<br /><br />It seemed a daunting task. The first step i took was looking at py-bcrypt module. It contains
two files;<br /><br /><ul><br />   <li> __init__.py </li><br />   <li> _bcrytp.so </li><br /></ul><br /><br />You can't edit _bcrytp.so file as it a library file. So i looked at __init__.py, which imports the os module and defines the <b>gensalt</b> function. From my the Python 2.5 installation on my Mac i copied the urandom implementation into __init__.py just above the line where <b> import os </b>. urandom is not that complex , it just tries to open /dev/urandom and reads in <b> n </b> number of bytes and return it. So here is what __init__.py looks like after the changes, its a hack. <br /><br /><font color="#fcf305">25 </font><font color="#cd5c5c">from</font>&nbsp;os <font color="#cd5c5c">import</font>&nbsp;O_RDONLY,read<br /><font color="#fcf305">26 </font><br /><font color="#fcf305">27 </font><font color="#f0e68c"><b>def</b></font>&nbsp;<font color="#98fb98">urandom</font>(n):<br /><font color="#fcf305">28 </font>&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color:
#333333"><font color="#ffffff">&quot;&quot;&quot;</font></span><font color="#ffa0a0">urandom(n) -&gt; str</font><br /><font color="#fcf305">29 </font><br /><font color="#fcf305">30 </font><font color="#ffa0a0">&nbsp;&nbsp;&nbsp;&nbsp;Return a string of n random bytes suitable for cryptographic use.</font><br /><font color="#fcf305">31 </font><br /><font color="#fcf305">32 </font><font color="#ffa0a0">&nbsp;&nbsp;&nbsp;&nbsp;</font><span style="background-color: "#333333"><font color="#ffffff">&quot;&quot;&quot;</font></span><br /><font color="#fcf305">33" </font>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#f0e68c"><b>try</b></font>:<br /><font color="#fcf305">34 </font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_urandomfd = open(<span style="background-color: #333333"><font color="#ffffff">&quot;</font></span><font color="#ffa0a0">/dev/urandom</font><span style="background-color: #333333"><font color="#ffffff">&quot;</font></span>,<span style="background-color: #333333"><font
color="#ffffff">'</font></span><font color="#ffa0a0">r</font><span style="background-color: #333333"><font color="#ffffff">'</font></span>&nbsp;)<br /><font color="#fcf305">35 </font>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#f0e68c"><b>except</b></font>&nbsp;(OSError, IOError):<br /><font color="#fcf305">36 </font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#f0e68c"><b>raise</b></font>&nbsp;Exception(<span style="background-color: #333333"><font color="#ffffff">&quot;</font></span><font color="#ffa0a0">/dev/urandom (or equivalent) not found</font><span style="background-color: #333333"><font color="#ffffff">&quot;</font></span>)<br /><font color="#fcf305">37 </font>&nbsp;&nbsp;&nbsp;&nbsp;bytes = <span style="background-color: #333333"><font color="#ffffff">&quot;&quot;</font></span><br /><font color="#fcf305">38 </font><br /><font color="#fcf305">39 </font>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#f0e68c"><b>while</b></font>&nbsp;len(bytes) &lt; n:<br /><font
color="#fcf305">40 </font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bytes += _urandomfd.read(n-len(bytes))<br /><font color="#fcf305">41 </font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#87ceeb">#bytes += read(_urandomfd, n - len(bytes))</font><br /><font color="#fcf305">42 </font><br /><font color="#fcf305">43 </font>&nbsp;&nbsp;&nbsp;&nbsp;_urandomfd.close()<br><br /><font color="#fcf305">44 </font>&nbsp;&nbsp;&nbsp;&nbsp;<font color="#f0e68c"><b>return</b></font>&nbsp;bytes<br><br /><font color="#fcf305">45 </font><br /><font color="#fcf305">46 </font><font color="#cd5c5c">import</font>&nbsp;os<br><br /><font color="#fcf305">47 </font>os.urandom = urandom<br /><font color="#fcf305">48 </font><font color="#cd5c5c">from</font>&nbsp;_bcrypt <font color="#cd5c5c">import</font>&nbsp;<br /><br /><br />Now py-bcrypt works and passwords are hashable. <br /><br />The thing that troubles me and is a question on my mind, is it worth the risk to install Python >= 2.4 on
a server that contains 'live shops' ? The risk being totally blowing up the default Python installation (2.3) and bringing down the shops ? I would have probably installed a new version of Python and sandboxed it. The irony is that the senior developer was the one who chose py-crypt and told me to <i>come up with a decorator for methods which need to be password protected</i>. I would have thought that with his experience he would have guessed that the request for the app to go online would have come. Also if you are scared to blow the default installation of Python on the production server, WHY PUT AN IN HOUSE APPLICATION THERE?<br /><br /><a href="https://technorati.com/tag/python" rel="tag"><img style="border:0;vertical-align:middle;margin-left:.4em" src="https://static.technorati.com/static/img/pub/icon-utag-16x13.png?tag=python" alt=" " />python</a>
